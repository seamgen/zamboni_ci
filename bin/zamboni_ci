#!/usr/bin/env ruby

require 'optparse'
require 'curb'
require 'spaceship'
require_relative "../lib/zamboni_ci/command_parser"
require_relative "../lib/zamboni_ci/device_parser"
require_relative "../lib/zamboni_ci/hockey_crawler"

#parse command line arguments
arg_array = ARGV
options = CommandParser.parse arg_array

crawler = HockeyCrawler.new(ENV["ZAMBONI_HOCKEY_USERNAME"], ENV["ZAMBONI_HOCKEY_PASSWORD"], options.hockey_app_id)

device_list = crawler.scrape_hockey

hockey_devices = DeviceParser.parse_hockey(device_list)

# Log into Apple Portal
Spaceship::Portal.login(ENV["ZAMBONI_APPLE_ID_EMAIL"], ENV["ZAMBONI_APPLE_ID_PASSWORD"])

# Find provisioning profile
all_profiles = Spaceship::Portal.provisioning_profile.find_by_bundle_id(options.bundle_id)
profile = all_profiles.last

# Find devices to add
spaceship_devices = DeviceParser.parse_spaceship(profile.devices)

devices_to_add = DeviceParser.find_new_devices(hockey_devices, spaceship_devices)

# Print devices to add
devices_to_add.each do |device|
   puts "add: " + device.name + " " + device.udid
end
